{% extends "base.html" %}

{% block title %}Payment History{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tenant.css') }}">
{% endblock %}


{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Payment History for {{ property.name }}</h2>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Receipt</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td>{{ payment.payment_date }}</td>
                            <td>₹{{ "%.2f"|format(payment.amount) }}</td>
                            <td>
                                {% if payment.status == 'paid' %}
                                    <span class="badge badge-success">Paid</span>
                                {% elif payment.status == 'pending' %}
                                    <span class="badge badge-warning">Pending</span>
                                {% else %}
                                    <span class="badge badge-danger">Rejected</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if payment.status == 'paid' %}
                                    <button class="btn btn-sm btn-outline-primary"
                                            onclick="generateReceiptPDF({{ payment.id }})">
                                        <i class="fas fa-file-pdf"></i> Download
                                    </button>
                                {% else %}
                                    <span class="text-muted">Not available</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center">No payments recorded yet</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-4 text-center">
                <a href="{{ url_for('tenant_dashboard') }}" class="btn btn-link" style="width: auto; padding: 0.25rem 0.5rem; font-size: 0.875rem; line-height: 1.5; border-radius: 0.2rem; background-color: transparent; border: none; color: #212529;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Hidden div for PDF generation -->
<div id="receipt-template" style="position: absolute; left: -9999px; top: -9999px;">
    <div class="container">
        <div class="watermark">PAID RECEIPT</div>

        <div class="header">
            <h1>RENT RECEIPT</h1>
            <div class="receipt-meta">
                <div>Receipt #<span></span></div>
                <div>Date: <span></span></div>
            </div>
            <div style="clear: both;"></div> <!-- Clear floats -->
        </div>

        <div class="section-title">Bill To</div>
        <div class="address-block">
            <strong></strong>
            <span></span><br>
            <span></span><br>
            <span></span><br>
            <span></span>
        </div>

        <div class="section-title">Bill From</div>
        <div class="address-block">
            <strong></strong>
            <span></span><br>
            <span></span><br>
            <span></span><br>
        </div>

        <div class="section-title">Payment Details</div>
        <table class="payment-details">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Period</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Rent Payment</td>
                    <td></td>
                    <td class="amount-cell">₹<span></span></td>
                </tr>
                <tr>
                    <td colspan="3">Notes: <span></span></td>
                </tr>
                <tr>
                    <td colspan="3">Transaction ID: <span></span></td>
                </tr>
            </tbody>
        </table>

        <div class="total-section">
            <span class="label">TOTAL PAID</span>
            <span class="value">₹<span></span></span>
            <div style="clear: both;"></div> <!-- Clear floats -->
        </div>

        <div class="footer">
            Thank you for your payment!<br>
            This is a computer-generated receipt.
        </div>
    </div>
</div>

<script>
    async function generateReceiptPDF(paymentId) {
        try {
            const payments = {{ payments | tojson }}; // Pass payments data from Flask to JS
            const tenancy = {{ tenancy | tojson }}; // Pass tenancy data
            const owner = {{ owner | tojson }}; // Pass owner data
            const tenant = {{ tenant | tojson }}; // Pass tenant data
            const property = {{ property | tojson }}; // Pass property data

            const payment = payments.find(p => p.id === paymentId);

            if (!payment) {
                alert('Error: Payment details not found for this ID.');
                return;
            }

            // Validate essential data
            if (!tenancy || !owner || !tenant || !property) {
                alert('Error: Missing essential tenancy, owner, tenant, or property data.');
                console.error('Missing data:', { tenancy, owner, tenant, property });
                return;
            }

            const receiptTemplate = document.getElementById('receipt-template');
            if (!receiptTemplate) {
                alert('Error: Receipt template not found in the DOM.');
                return;
            }

            const clonedReceipt = receiptTemplate.cloneNode(true);
            clonedReceipt.style.position = 'static'; // Make it visible for html2canvas
            clonedReceipt.style.left = '0';
            clonedReceipt.style.top = '0';
            clonedReceipt.style.width = '210mm'; // A4 width for consistent rendering
            clonedReceipt.style.padding = '20mm'; // Add some padding for A4
            clonedReceipt.style.boxSizing = 'border-box';
            clonedReceipt.style.backgroundColor = '#ffffff'; // Ensure white background

            // Populate data
            clonedReceipt.querySelector('.watermark').textContent = 'PAID RECEIPT';
            clonedReceipt.querySelector('.header h1').textContent = 'RENT RECEIPT';

            // Receipt Meta
            const paymentDateObj = new Date(payment.payment_date);
            clonedReceipt.querySelector('.receipt-meta div:first-child span').textContent = payment.id || 'N/A';
            clonedReceipt.querySelector('.receipt-meta div:last-child span').textContent = paymentDateObj instanceof Date && !isNaN(paymentDateObj) ? paymentDateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : 'N/A Date';

            // Bill To
            const billToBlock = clonedReceipt.querySelector('.address-block:nth-of-type(1)');
            if (billToBlock) {
                billToBlock.querySelector('strong').textContent = tenant.full_name || 'N/A';
                billToBlock.querySelector('span:nth-of-type(1)').textContent = tenant.phone || '';
                billToBlock.querySelector('span:nth-of-type(2)').textContent = tenant.email || '';
                billToBlock.querySelector('span:nth-of-type(3)').textContent = property.name || 'N/A';
                billToBlock.querySelector('span:nth-of-type(4)').textContent = property.address || 'N/A';
            }

            // Bill From
            const billFromBlock = clonedReceipt.querySelector('.address-block:nth-of-type(2)');
            if (billFromBlock) {
                billFromBlock.querySelector('strong').textContent = owner.full_name || 'N/A';
                billFromBlock.querySelector('span:nth-of-type(1)').textContent = owner.phone || '';
                billFromBlock.querySelector('span:nth-of-type(2)').textContent = owner.email || '';
                billFromBlock.querySelector('span:nth-of-type(3)').textContent = owner.upi_.id ? `UPI ID: ${owner.upi_id}` : '';
            }

            // Payment Details Table
            const paymentDetailsTable = clonedReceipt.querySelector('.payment-details tbody');
            if (paymentDetailsTable) {
                paymentDetailsTable.querySelector('tr:nth-child(1) td:nth-child(1)').textContent = 'Rent Payment';
                paymentDetailsTable.querySelector('tr:nth-child(1) td:nth-child(2)').textContent = paymentDateObj instanceof Date && !isNaN(paymentDateObj) ? paymentDateObj.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' }) : 'N/A Period';
                paymentDetailsTable.querySelector('tr:nth-child(1) .amount-cell span').textContent = parseFloat(payment.amount).toFixed(2) || '0.00';

                paymentDetailsTable.querySelector('tr:nth-child(2) span').textContent = payment.notes || 'N/A';
                paymentDetailsTable.querySelector('tr:nth-child(3) span').textContent = payment.upi_txn_id || 'N/A';
            }

            // Total Section
            const totalSectionValue = clonedReceipt.querySelector('.total-section .value span');
            if (totalSectionValue) {
                totalSectionValue.textContent = parseFloat(payment.amount).toFixed(2) || '0.00';
            }

            // Append to body for rendering
            document.body.appendChild(clonedReceipt);

            const containerToCapture = clonedReceipt.querySelector('.container');
            if (!containerToCapture) {
                alert('Error: Inner container for PDF capture not found.');
                document.body.removeChild(clonedReceipt);
                return;
            }

            const canvas = await html2canvas(containerToCapture, {
                scale: 2, // Higher scale for better quality
                useCORS: true,
                allowTaint: false,
                backgroundColor: '#ffffff',
                logging: false,
            });

            if (!canvas || canvas.width === 0 || canvas.height === 0) {
                throw new Error('Failed to capture receipt canvas.');
            }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210; // A4 width in mm
            const pageHeight = (canvas.height * imgWidth) / canvas.width;

            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, pageHeight);
            pdf.save(`receipt_${payment.id}.pdf`);

            alert('PDF generated successfully!');
        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Failed to generate PDF. Please check the console for details.');
        } finally {
            if (clonedReceipt && clonedReceipt.parentNode) {
                document.body.removeChild(clonedReceipt); // Clean up
            }
        }
    }
</script>

{% endblock %}