{% extends "base.html" %}

{% block title %}Pay Rent{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tenant.css') }}">
{% endblock %}

{% block content %}
<!-- Add CSRF token meta tag -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="payment-container">
    <h1>Pay Rent for {{ tenancy.property.name }}</h1>

    <div class="payment-details">
        <p><strong>Amount Due:</strong> ₹{{ tenancy.rent_amount }}</p>
        <p><strong>Owner:</strong> {{ owner.full_name }}</p>
        {% if owner.upi_id %}
        <p><strong>UPI ID:</strong> {{ owner.upi_id }}</p>
        {% endif %}
    </div>

    <div class="payment-options">
        <div class="method-tabs">
            <div class="method-tab active" id="upi-tab">UPI Payment</div>
            <div class="method-tab" id="manual-tab">Manual Payment</div>
        </div>

        <div class="payment-method active" id="upi-method">
            {% if owner.upi_id %}
            <div class="upi-payment-card">
                <h3><span class="icon-upi"></span> Pay via UPI</h3>
                <p>Click below to automatically open your UPI app:</p>
                <button class="btn btn-primary upi-pay-button" id="upi-pay-now">
                    <span>Pay ₹{{ tenancy.rent_amount }}</span>
                </button>
                <div class="upi-apps">
                    <div class="upi-app-icon gpay"></div>
                    <div class="upi-app-icon phonepe"></div>
                    <div class="upi-app-icon paytm"></div>
                </div>
                <p class="note">Will open your default UPI app with all details pre-filled</p>
            </div>
            {% else %}
            <div class="warning">
                <p>Owner hasn't provided a UPI ID for online payments</p>
            </div>
            {% endif %}
        </div>

        <div class="payment-method" id="manual-method">
            <form method="POST" class="manual-payment-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <h3><span class="icon-manual"></span> Record Payment</h3>
                <div class="form-group">
                    <label for="upi_txn_id">Transaction Reference (optional)</label>
                    <input type="text" id="upi_txn_id" name="upi_txn_id" placeholder="Enter UPI Transaction ID">
                </div>
                <div class="form-group">
                    <label for="notes">Payment Notes (optional)</label>
                    <textarea id="notes" name="notes" placeholder="Any additional details"></textarea>
                </div>
                <input type="hidden" name="payment_method" value="manual">
                <button type="submit" class="btn btn-primary">Confirm Payment</button>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h3>Payment Confirmation</h3>
            <p>Did you successfully complete the payment?</p>
            <div class="modal-buttons">
                <button id="confirm-payment" class="btn-success">Yes, Payment Done</button>
                <button id="cancel-payment" class="btn-cancel">No, Payment Failed</button>
            </div>
        </div>
    </div>

    <div class="mt-4 text-center">
        <a href="{{ url_for('tenant_dashboard') }}" class="btn btn-link" style="width: auto; padding: 0.25rem 0.5rem; font-size: 0.875rem; line-height: 1.5; border-radius: 0.2rem; background-color: transparent; border: none; color: #212529;">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    const upiTab = document.getElementById('upi-tab');
    const manualTab = document.getElementById('manual-tab');
    const upiMethod = document.getElementById('upi-method');
    const manualMethod = document.getElementById('manual-method');

    // Function to switch tabs
    function switchTab(activeTab, inactiveTab, activeMethod, inactiveMethod) {
        if (activeTab && inactiveTab && activeMethod && inactiveMethod) {
            activeTab.classList.add('active');
            inactiveTab.classList.remove('active');
            activeMethod.classList.add('active');
            inactiveMethod.classList.remove('active');
        }
    }

    if (upiTab && manualTab && upiMethod && manualMethod) {
        upiTab.addEventListener('click', function() {
            switchTab(upiTab, manualTab, upiMethod, manualMethod);
        });

        manualTab.addEventListener('click', function() {
            switchTab(manualTab, upiTab, manualMethod, upiMethod);
        });
    }

    // UPI payment flow
    const upiButton = document.getElementById('upi-pay-now');
    const modal = document.getElementById('confirmation-modal');
    const confirmBtn = document.getElementById('confirm-payment');
    const cancelBtn = document.getElementById('cancel-payment');

    if (upiButton) {
        upiButton.addEventListener('click', function(e) {
            e.preventDefault();

            // Store original button text
            const originalText = upiButton.innerHTML;

            // Show loading state
            upiButton.disabled = true;
            upiButton.innerHTML = '<span>Opening UPI app...</span>';

            // Try to open UPI app
            try {
                const upiLink = "{{ upi_link|safe }}";
                if (upiLink) {
                    window.open(upiLink, '_blank');
                } else {
                    throw new Error('UPI link not found');
                }

                // Show confirmation modal when the user returns to the tab
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        if (modal) {
                            modal.style.display = 'flex';
                        }
                        // Reset button state
                        upiButton.disabled = false;
                        upiButton.innerHTML = originalText;
                    }
                });
            } catch (error) {
                console.error('Error opening UPI app:', error);
                alert('Failed to open UPI app. Please try again or use manual payment method.');
                upiButton.disabled = false;
                upiButton.innerHTML = originalText;
            }
        });
    }

    if (confirmBtn && modal) {
        confirmBtn.addEventListener('click', function() {
            // Store original button text
            const originalText = confirmBtn.innerHTML;

            // Show loading state
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = 'Processing...';

            // Get CSRF token
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            if (!csrfMeta) {
                console.error('CSRF token not found');
                alert('Security error. Please refresh the page and try again.');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
                return;
            }

            const csrfToken = csrfMeta.content;

            // Send confirmation to server
            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'confirm_payment': 'true',
                    'csrf_token': csrfToken
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    // Redirect on success
                    window.location.href = data.redirect_url || "{{ url_for('tenant_dashboard') }}";
                } else {
                    throw new Error(data?.message || 'Payment confirmation failed');
                }
            })
            .catch(error => {
                console.error('Payment confirmation error:', error);
                alert('Payment confirmation failed: ' + error.message);
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
            })
            .finally(() => {
                modal.style.display = 'none';
            });
        });
    }

    if (cancelBtn && modal) {
        cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
    }

    if (notification) {
        // Close notification when clicking outside
        document.addEventListener('click', function(event) {
            if (!notification.contains(event.target) && event.target !== upiButton) {
                notification.style.display = 'none';
            }
        });

        // Close notification with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && notification.style.display === 'block') {
                notification.style.display = 'none';
            }
        });
    }
});// Add this to your existing JavaScript
function showPaymentStatusModal(message, isSuccess) {
    const modal = document.createElement('div');
    modal.className = 'payment-status-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>${isSuccess ? '✅ Success' : '⚠️ Notice'}</h3>
            <p>${message}</p>
            <button onclick="this.parentElement.parentElement.remove()">OK</button>
        </div>
    `;
    document.body.appendChild(modal);
}

// After successful payment confirmation in your existing code
fetch('/confirm_upi_payment/' + tenancyId, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({
        status: 'completed',
        csrf_token: csrfToken
    })
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        showPaymentStatusModal(
            `Payment verification request sent to owner. Reference: ${data.reference}`,
            true
        );
    } else {
        showPaymentStatusModal(data.message || 'Payment confirmation failed', false);
    }
});

</script>
{% endblock %}